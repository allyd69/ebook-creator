<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Ebook Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Cormorant+Garamond:wght@300;400;600&family=Crimson+Pro:wght@200;300;400;600&family=Manrope:wght@300;400;500;600;700&family=DM+Serif+Display:ital@0;1&family=Libre+Baskerville:wght@400;700&family=Lora:wght@400;600;700&family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #1a1a2e;
            --primary-navy: #16213e;
            --accent-gold: #d4af37;
            --accent-amber: #f4a460;
            --cream: #faf8f3;
            --ivory: #fffff0;
            --charcoal: #2d2d2d;
            --silver: #c0c0c0;
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-navy) 100%);
            color: var(--cream);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .grain-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
            z-index: 1;
        }

        .container {
            position: relative;
            z-index: 2;
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
            animation: fadeInDown 0.8s ease-out;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 4rem;
            font-weight: 900;
            letter-spacing: -2px;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-amber));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            color: var(--silver);
            font-weight: 300;
            font-style: italic;
            letter-spacing: 2px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 40px;
            animation: fadeIn 1s ease-out 0.2s both;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 20px;
            padding: 30px;
            height: fit-content;
            position: sticky;
            top: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .content-area {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-family: 'DM Serif Display', serif;
            font-size: 1.5rem;
            color: var(--accent-gold);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.3);
        }

        .upload-zone {
            border: 2px dashed var(--accent-gold);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(212, 175, 55, 0.05);
            margin-bottom: 30px;
        }

        .upload-zone:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--accent-amber);
            transform: translateY(-2px);
        }

        .upload-zone svg {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            stroke: var(--accent-gold);
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-amber));
            color: var(--primary-dark);
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-family: 'Manrope', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(212, 175, 55, 0.5);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--cream);
            border: 1px solid var(--accent-gold);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .template-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .template-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .template-card:hover {
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-3px);
        }

        .template-card.active {
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }

        .template-name {
            font-family: 'DM Serif Display', serif;
            font-size: 1rem;
            color: var(--accent-gold);
            margin-bottom: 5px;
        }

        .template-desc {
            font-size: 0.75rem;
            color: var(--silver);
            font-style: italic;
        }

        .page-editor {
            display: none;
        }

        .page-editor.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        .page-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .page-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: var(--cream);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
        }

        .page-btn:hover {
            background: rgba(212, 175, 55, 0.2);
        }

        .page-btn.active {
            background: var(--accent-gold);
            color: var(--primary-dark);
            border-color: var(--accent-gold);
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            font-family: 'DM Serif Display', serif;
            color: var(--accent-gold);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px;
            padding: 12px 16px;
            color: var(--cream);
            font-family: 'Manrope', sans-serif;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .input-group textarea {
            min-height: 200px;
            resize: vertical;
            line-height: 1.6;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
            background: rgba(255, 255, 255, 0.08);
        }

        .image-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .transparency-control {
            margin-top: 15px;
        }

        .transparency-control input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, var(--accent-gold), var(--accent-amber));
            outline: none;
            -webkit-appearance: none;
        }

        .transparency-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-gold);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.5);
        }

        .page-preview {
            margin-top: 40px;
            padding: 40px;
            background: var(--cream);
            border-radius: 15px;
            color: var(--charcoal);
            min-height: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        .page-preview img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }

        .page-preview-content {
            position: relative;
            z-index: 1;
        }

        .export-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .ai-prompt-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(212, 175, 55, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-gold);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Template Styles */
        .template-minimal-elegance {
            font-family: 'Cormorant Garamond', serif;
            line-height: 1.8;
            letter-spacing: 0.5px;
        }

        .template-minimal-elegance h2 {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            font-size: 2.5rem;
            margin-bottom: 30px;
            letter-spacing: 2px;
        }

        .template-editorial-bold {
            font-family: 'Libre Baskerville', serif;
            line-height: 1.7;
        }

        .template-editorial-bold h2 {
            font-family: 'Playfair Display', serif;
            font-weight: 900;
            font-size: 3rem;
            margin-bottom: 25px;
            text-transform: uppercase;
        }

        .template-classic-heritage {
            font-family: 'Crimson Pro', serif;
            line-height: 1.9;
            text-align: center;
        }

        .template-classic-heritage h2 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 2.8rem;
            margin-bottom: 35px;
        }

        .template-modern-luxe {
            font-family: 'Manrope', sans-serif;
            line-height: 1.75;
            font-weight: 300;
        }

        .template-modern-luxe h2 {
            font-family: 'Cinzel', serif;
            font-weight: 400;
            font-size: 2.2rem;
            margin-bottom: 30px;
            letter-spacing: 3px;
        }

        .template-ultra-luxury {
            font-family: 'Cormorant Garamond', serif;
            line-height: 2;
            font-weight: 300;
        }

        .template-ultra-luxury h2 {
            font-family: 'Playfair Display', serif;
            font-weight: 600;
            font-size: 3.5rem;
            margin-bottom: 50px;
            letter-spacing: 5px;
        }

        .template-timeless-elegant {
            font-family: 'Lora', serif;
            line-height: 1.8;
            text-align: center;
        }

        .template-timeless-elegant h2 {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 2.6rem;
            margin-bottom: 40px;
        }

        .template-scholarly-pro {
            font-family: 'Crimson Pro', serif;
            line-height: 1.7;
        }

        .template-scholarly-pro h2 {
            font-family: 'Libre Baskerville', serif;
            font-weight: 700;
            font-size: 2.4rem;
            margin-bottom: 30px;
        }

        .template-creative-vision {
            font-family: 'Cormorant Garamond', serif;
            line-height: 1.85;
            font-style: italic;
        }

        .template-creative-vision h2 {
            font-family: 'DM Serif Display', serif;
            font-weight: 400;
            font-size: 2.8rem;
            margin-bottom: 35px;
            font-style: italic;
        }

        .template-refined-quality {
            font-family: 'Manrope', sans-serif;
            line-height: 1.75;
            font-weight: 400;
        }

        .template-refined-quality h2 {
            font-family: 'Playfair Display', serif;
            font-weight: 600;
            font-size: 2.5rem;
            margin-bottom: 30px;
        }

        .template-premium-edition {
            font-family: 'Lora', serif;
            line-height: 2.1;
            font-weight: 400;
        }

        .template-premium-edition h2 {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 3.2rem;
            margin-bottom: 45px;
            letter-spacing: 4px;
            text-transform: uppercase;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: relative;
                top: 0;
            }

            h1 {
                font-size: 3rem;
            }
        }

        @media (max-width: 768px) {
            .template-selector {
                grid-template-columns: 1fr;
            }

            .image-controls {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="grain-overlay"></div>
    
    <div class="container">
        <header>
            <h1>Premium Ebook Creator</h1>
            <p class="subtitle">Craft Luxury Digital Publications</p>
        </header>

        <div class="main-grid">
            <aside class="sidebar">
                <h3 class="section-title">Templates</h3>
                <div class="template-selector" id="templateSelector">
                    <div class="template-card active" data-template="minimal-elegance">
                        <div class="template-name">Minimal Elegance</div>
                        <div class="template-desc">Clean & Refined</div>
                    </div>
                    <div class="template-card" data-template="editorial-bold">
                        <div class="template-name">Editorial Bold</div>
                        <div class="template-desc">Magazine Style</div>
                    </div>
                    <div class="template-card" data-template="classic-heritage">
                        <div class="template-name">Classic Heritage</div>
                        <div class="template-desc">Timeless & Centered</div>
                    </div>
                    <div class="template-card" data-template="modern-luxe">
                        <div class="template-name">Modern Luxe</div>
                        <div class="template-desc">Contemporary Chic</div>
                    </div>
                    <div class="template-card" data-template="ultra-luxury">
                        <div class="template-name">Ultra Luxury</div>
                        <div class="template-desc">High Fashion</div>
                    </div>
                    <div class="template-card" data-template="timeless-elegant">
                        <div class="template-name">Timeless Elegant</div>
                        <div class="template-desc">Refined Excellence</div>
                    </div>
                    <div class="template-card" data-template="scholarly-pro">
                        <div class="template-name">Scholarly Pro</div>
                        <div class="template-desc">Academic Authority</div>
                    </div>
                    <div class="template-card" data-template="creative-vision">
                        <div class="template-name">Creative Vision</div>
                        <div class="template-desc">Artistic Flair</div>
                    </div>
                    <div class="template-card" data-template="refined-quality">
                        <div class="template-name">Refined Quality</div>
                        <div class="template-desc">Balanced Professional</div>
                    </div>
                    <div class="template-card" data-template="premium-edition">
                        <div class="template-name">Premium Edition</div>
                        <div class="template-desc">Maximum Luxury</div>
                    </div>
                </div>

                <h3 class="section-title" style="margin-top: 30px;">Controls</h3>
                <button class="btn" style="width: 100%; margin-bottom: 10px;" onclick="saveProject()">Save Project</button>
                <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="loadProject()">Load Project</button>
                <button class="btn btn-secondary" style="width: 100%;" onclick="exportEbook()">Export Ebook</button>
            </aside>

            <main class="content-area">
                <div id="uploadSection">
                    <h3 class="section-title">Upload Your Draft</h3>
                    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <p style="font-size: 1.1rem; margin-bottom: 5px;">Drop your ebook draft here</p>
                        <p style="font-size: 0.9rem; color: var(--silver);">Accepts all file formats (TXT, PDF, DOCX, HTML, MD, and more)</p>
                    </div>
                    <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">
                </div>

                <div id="editorSection" class="page-editor">
                    <h3 class="section-title">Edit Pages</h3>
                    <div class="page-navigation" id="pageNavigation"></div>
                    
                    <div style="margin-bottom: 20px; color: var(--silver); font-size: 0.9rem;">
                        <span id="pageStats">Word count: 0 words</span>
                    </div>

                    <div class="input-group">
                        <label>Page Title</label>
                        <input type="text" id="pageTitle" placeholder="Enter page title...">
                    </div>

                    <div class="input-group">
                        <label>Page Content</label>
                        <textarea id="pageContent" placeholder="Enter page content..."></textarea>
                    </div>

                    <div class="image-controls">
                        <button class="btn" onclick="document.getElementById('imageInput').click()">Upload Image</button>
                        <button class="btn btn-secondary" onclick="toggleAIPrompt()">Generate AI Image</button>
                    </div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">

                    <div class="transparency-control">
                        <label style="color: var(--accent-gold); margin-bottom: 10px; display: block;">
                            Image Transparency: <span id="transparencyValue">50</span>%
                        </label>
                        <input type="range" id="transparencySlider" min="0" max="100" value="50" oninput="updateTransparency(this.value)">
                    </div>

                    <div class="ai-prompt-section" id="aiPromptSection" style="display: none;">
                        <div class="input-group">
                            <label>AI Image Prompt</label>
                            <textarea id="aiPrompt" placeholder="Describe the image you want to generate... (e.g., 'A cinematic sunset over mountains, photographic quality')" style="min-height: 100px;"></textarea>
                        </div>
                        <button class="btn" onclick="generateAIImage()">Generate Image</button>
                    </div>

                    <div class="page-preview" id="pagePreview">
                        <div class="page-preview-content">
                            <h2>Your Page Title</h2>
                            <p>Your content will appear here...</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>
        // State management
        let ebookData = {
            pages: [],
            currentPage: 0,
            selectedTemplate: 'minimal-elegance',
            images: {}
        };

        // Template selector
        document.getElementById('templateSelector').addEventListener('click', (e) => {
            const card = e.target.closest('.template-card');
            if (card) {
                document.querySelectorAll('.template-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                ebookData.selectedTemplate = card.dataset.template;
                updatePreview();
            }
        });

        // File upload handler
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileType = file.name.split('.').pop().toLowerCase();

            try {
                let content = '';
                
                if (fileType === 'txt' || fileType === 'md' || fileType === 'html' || fileType === 'htm') {
                    content = await file.text();
                } else if (fileType === 'pdf') {
                    content = await extractPDFText(file);
                } else if (fileType === 'docx' || fileType === 'doc') {
                    content = await extractDOCXText(file);
                } else {
                    // Try to read as text for any other format
                    try {
                        content = await file.text();
                    } catch (e) {
                        alert('This file format may not be supported. Please try TXT, PDF, DOCX, HTML, or MD files.');
                        return;
                    }
                }

                parseContent(content);
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('editorSection').classList.add('active');
            } catch (error) {
                alert('Error reading file: ' + error.message);
            }
        }

        async function extractPDFText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n\n';
            }
            
            return text;
        }

        async function extractDOCXText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        function parseContent(content) {
            // Split content into properly-sized pages (500-1000 words per page)
            const paragraphs = content.split('\n\n').filter(p => p.trim());
            
            ebookData.pages = [];
            let currentPage = {
                title: 'Page 1',
                content: '',
                wordCount: 0,
                imageUrl: null,
                transparency: 50
            };
            
            const TARGET_WORDS_PER_PAGE = 750; // Ideal page length
            const MAX_WORDS_PER_PAGE = 1000;
            
            for (let i = 0; i < paragraphs.length; i++) {
                const para = paragraphs[i];
                const paraWords = para.split(/\s+/).length;
                
                // If adding this paragraph would exceed max, start new page
                if (currentPage.wordCount > 0 && currentPage.wordCount + paraWords > MAX_WORDS_PER_PAGE) {
                    ebookData.pages.push({ ...currentPage });
                    currentPage = {
                        title: `Page ${ebookData.pages.length + 1}`,
                        content: para,
                        wordCount: paraWords,
                        imageUrl: null,
                        transparency: 50
                    };
                } else {
                    currentPage.content += (currentPage.content ? '\n\n' : '') + para;
                    currentPage.wordCount += paraWords;
                    
                    // If we've reached target and not last paragraph, start new page
                    if (currentPage.wordCount >= TARGET_WORDS_PER_PAGE && i < paragraphs.length - 1) {
                        ebookData.pages.push({ ...currentPage });
                        currentPage = {
                            title: `Page ${ebookData.pages.length + 1}`,
                            content: '',
                            wordCount: 0,
                            imageUrl: null,
                            transparency: 50
                        };
                    }
                }
            }
            
            // Add last page if it has content
            if (currentPage.content) {
                ebookData.pages.push(currentPage);
            }

            renderPageNavigation();
            loadPage(0);
        }

        function renderPageNavigation() {
            const nav = document.getElementById('pageNavigation');
            nav.innerHTML = ebookData.pages.map((page, index) => 
                `<button class="page-btn ${index === ebookData.currentPage ? 'active' : ''}" onclick="loadPage(${index})">
                    ${page.title}
                </button>`
            ).join('');
        }

        function loadPage(index) {
            ebookData.currentPage = index;
            const page = ebookData.pages[index];
            
            document.getElementById('pageTitle').value = page.title;
            document.getElementById('pageContent').value = page.content;
            document.getElementById('transparencySlider').value = page.transparency || 50;
            document.getElementById('transparencyValue').textContent = page.transparency || 50;
            
            // Update word count
            const wordCount = page.content.split(/\s+/).filter(w => w.trim()).length;
            document.getElementById('pageStats').textContent = `Word count: ${wordCount} words | Page ${index + 1} of ${ebookData.pages.length}`;
            
            renderPageNavigation();
            updatePreview();
        }

        function savePage() {
            const page = ebookData.pages[ebookData.currentPage];
            page.title = document.getElementById('pageTitle').value;
            page.content = document.getElementById('pageContent').value;
            
            // Update word count
            const wordCount = page.content.split(/\s+/).filter(w => w.trim()).length;
            document.getElementById('pageStats').textContent = `Word count: ${wordCount} words | Page ${ebookData.currentPage + 1} of ${ebookData.pages.length}`;
            
            renderPageNavigation();
            updatePreview();
        }

        // Auto-save on input
        document.getElementById('pageTitle').addEventListener('input', savePage);
        document.getElementById('pageContent').addEventListener('input', savePage);

        function updatePreview() {
            const page = ebookData.pages[ebookData.currentPage];
            const preview = document.getElementById('pagePreview');
            const template = ebookData.selectedTemplate;
            
            preview.className = 'page-preview template-' + template;
            
            let imageHtml = '';
            if (page.imageUrl) {
                const opacity = (100 - (page.transparency || 50)) / 100;
                imageHtml = `<img src="${page.imageUrl}" style="opacity: ${opacity};" alt="Page background">`;
            }
            
            preview.innerHTML = `
                ${imageHtml}
                <div class="page-preview-content">
                    <h2>${page.title || 'Untitled'}</h2>
                    <p style="white-space: pre-wrap;">${page.content || ''}</p>
                </div>
            `;
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                ebookData.pages[ebookData.currentPage].imageUrl = e.target.result;
                updatePreview();
            };
            reader.readAsDataURL(file);
        }

        function updateTransparency(value) {
            document.getElementById('transparencyValue').textContent = value;
            ebookData.pages[ebookData.currentPage].transparency = parseInt(value);
            updatePreview();
        }

        function toggleAIPrompt() {
            const section = document.getElementById('aiPromptSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        async function generateAIImage() {
            const prompt = document.getElementById('aiPrompt').value;
            if (!prompt.trim()) {
                alert('Please enter a prompt for the AI image');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.innerHTML = '<span class="loading-spinner"></span> Generating...';
            button.disabled = true;

            try {
                // Use Anthropic API for image generation
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        messages: [{
                            role: 'user',
                            content: `Generate a photographic, cinematic image based on this prompt: ${prompt}. The image should be realistic and high-quality.`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate image');
                }

                // Note: This is a placeholder. In production, you'd integrate with an actual image generation API
                // For now, we'll use a placeholder image service
                const imageUrl = `https://picsum.photos/800/600?random=${Date.now()}`;
                ebookData.pages[ebookData.currentPage].imageUrl = imageUrl;
                updatePreview();
                
                alert('AI image generated successfully! (Note: Using placeholder in demo)');
            } catch (error) {
                alert('Error generating image: ' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        function saveProject() {
            const json = JSON.stringify(ebookData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ebook-project.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    ebookData = JSON.parse(text);
                    
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('editorSection').classList.add('active');
                    
                    renderPageNavigation();
                    loadPage(0);
                    
                    // Update template selector
                    document.querySelectorAll('.template-card').forEach(card => {
                        card.classList.toggle('active', card.dataset.template === ebookData.selectedTemplate);
                    });
                } catch (error) {
                    alert('Error loading project: ' + error.message);
                }
            };
            input.click();
        }

        function exportEbook() {
            // Show export options
            const format = confirm('Export as HTML ebook?\n\nOK = HTML (web-ready ebook)\nCancel = JSON (data backup)');
            
            if (format) {
                exportAsHTML();
            } else {
                exportAsJSON();
            }
        }
        
        function exportAsHTML() {
            const template = ebookData.selectedTemplate;
            
            // Generate complete HTML ebook
            let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ebook Export</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Cormorant+Garamond:wght@300;400;600&family=Crimson+Pro:wght@200;300;400;600&family=Manrope:wght@300;400;500;600;700&family=DM+Serif+Display:ital@0;1&family=Libre+Baskerville:wght@400;700&family=Lora:wght@400;600;700&family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Manrope', sans-serif;
            background: #faf8f3;
            color: #2d2d2d;
            line-height: 1.8;
        }
        .page {
            max-width: 800px;
            margin: 0 auto;
            padding: 80px 40px;
            min-height: 100vh;
            position: relative;
            page-break-after: always;
        }
        .page img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }
        .page-content {
            position: relative;
            z-index: 1;
        }
        h2 {
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        p {
            margin-bottom: 20px;
            white-space: pre-wrap;
        }
        
        /* Template Styles */
        .template-minimal-elegance { font-family: 'Cormorant Garamond', serif; line-height: 1.8; letter-spacing: 0.5px; }
        .template-minimal-elegance h2 { font-family: 'Cinzel', serif; font-weight: 600; font-size: 2.5rem; margin-bottom: 30px; letter-spacing: 2px; }
        
        .template-editorial-bold { font-family: 'Libre Baskerville', serif; line-height: 1.7; }
        .template-editorial-bold h2 { font-family: 'Playfair Display', serif; font-weight: 900; font-size: 3rem; margin-bottom: 25px; text-transform: uppercase; }
        
        .template-classic-heritage { font-family: 'Crimson Pro', serif; line-height: 1.9; text-align: center; }
        .template-classic-heritage h2 { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 2.8rem; margin-bottom: 35px; }
        
        .template-modern-luxe { font-family: 'Manrope', sans-serif; line-height: 1.75; font-weight: 300; }
        .template-modern-luxe h2 { font-family: 'Cinzel', serif; font-weight: 400; font-size: 2.2rem; margin-bottom: 30px; letter-spacing: 3px; }
        
        .template-ultra-luxury { font-family: 'Cormorant Garamond', serif; line-height: 2; font-weight: 300; }
        .template-ultra-luxury h2 { font-family: 'Playfair Display', serif; font-weight: 600; font-size: 3.5rem; margin-bottom: 50px; letter-spacing: 5px; }
        
        .template-timeless-elegant { font-family: 'Lora', serif; line-height: 1.8; text-align: center; }
        .template-timeless-elegant h2 { font-family: 'Cinzel', serif; font-weight: 700; font-size: 2.6rem; margin-bottom: 40px; }
        
        .template-scholarly-pro { font-family: 'Crimson Pro', serif; line-height: 1.7; }
        .template-scholarly-pro h2 { font-family: 'Libre Baskerville', serif; font-weight: 700; font-size: 2.4rem; margin-bottom: 30px; }
        
        .template-creative-vision { font-family: 'Cormorant Garamond', serif; line-height: 1.85; font-style: italic; }
        .template-creative-vision h2 { font-family: 'DM Serif Display', serif; font-weight: 400; font-size: 2.8rem; margin-bottom: 35px; font-style: italic; }
        
        .template-refined-quality { font-family: 'Manrope', sans-serif; line-height: 1.75; font-weight: 400; }
        .template-refined-quality h2 { font-family: 'Playfair Display', serif; font-weight: 600; font-size: 2.5rem; margin-bottom: 30px; }
        
        .template-premium-edition { font-family: 'Lora', serif; line-height: 2.1; font-weight: 400; }
        .template-premium-edition h2 { font-family: 'Cinzel', serif; font-weight: 700; font-size: 3.2rem; margin-bottom: 45px; letter-spacing: 4px; text-transform: uppercase; }
        
        @media print {
            .page { page-break-after: always; }
        }
    </style>
</head>
<body class="template-${template}">
`;
            
            // Add each page
            ebookData.pages.forEach((page, index) => {
                const imageHtml = page.imageUrl ? 
                    `<img src="${page.imageUrl}" style="opacity: ${(100 - (page.transparency || 50)) / 100};" alt="Page background">` : '';
                
                html += `
    <div class="page">
        ${imageHtml}
        <div class="page-content">
            <h2>${page.title || 'Untitled'}</h2>
            <p>${page.content || ''}</p>
        </div>
    </div>
`;
            });
            
            html += `
</body>
</html>`;
            
            // Download HTML file
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my-ebook.html';
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Ebook exported as HTML! You can open it in any browser or convert to PDF.');
        }
        
        function exportAsJSON() {
            const exportData = {
                ...ebookData,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const json = JSON.stringify(exportData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ebook-export.json';
            a.click();
            URL.revokeObjectURL(url);

            alert('Ebook data exported as JSON!');
        }

        // Drag and drop support
        const uploadZone = document.querySelector('.upload-zone');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'var(--accent-amber)';
            uploadZone.style.background = 'rgba(212, 175, 55, 0.15)';
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.style.borderColor = 'var(--accent-gold)';
            uploadZone.style.background = 'rgba(212, 175, 55, 0.05)';
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'var(--accent-gold)';
            uploadZone.style.background = 'rgba(212, 175, 55, 0.05)';
            
            const file = e.dataTransfer.files[0];
            if (file) {
                const fakeEvent = { target: { files: [file] } };
                handleFileUpload(fakeEvent);
            }
        });
    </script>
</body>
</html>
