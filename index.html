<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Ebook Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lora:wght@400&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Lora', serif;
            background: #1a1a2e;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            padding: 40px;
            border-radius: 15px;
        }
        h1 {
            font-family: 'Playfair Display', serif;
            color: #d4af37;
            text-align: center;
            margin-bottom: 40px;
        }
        .upload-zone {
            border: 2px dashed #d4af37;
            padding: 60px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 30px;
        }
        .upload-zone:hover { background: rgba(212,175,55,0.1); }
        .btn {
            background: #d4af37;
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
            margin: 10px;
        }
        .btn:hover { background: #f4a460; }
        .editor { display: none; }
        .editor.active { display: block; }
        .page-nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .page-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid #d4af37;
            color: #fff;
            padding: 8px 15px;
            cursor: pointer;
        }
        .page-btn.active { background: #d4af37; color: #1a1a2e; }
        input, textarea {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid #d4af37;
            color: #fff;
            padding: 10px;
            margin-bottom: 20px;
        }
        textarea { min-height: 300px; font-family: 'Lora', serif; line-height: 1.8; }
        .preview {
            background: #faf8f3;
            color: #2d2d2d;
            padding: 60px;
            margin-top: 30px;
            min-height: 500px;
            font-family: 'Lora', serif;
            line-height: 1.9;
        }
        .preview h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            margin-bottom: 40px;
        }
        .preview p { margin-bottom: 25px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Premium Ebook Creator</h1>
        
        <div id="upload">
            <div class="upload-zone" onclick="document.getElementById('file').click()">
                <h2>Click to Upload Your Draft</h2>
                <p>Supports DOCX, PDF, TXT</p>
            </div>
            <input type="file" id="file" style="display:none" onchange="handleFile(event)">
        </div>

        <div id="editor" class="editor">
            <div class="page-nav" id="nav"></div>
            <input type="text" id="title" placeholder="Chapter Title">
            <textarea id="content" placeholder="Chapter content..."></textarea>
            <button class="btn" onclick="exportHTML()">Export Ebook</button>
            <div class="preview" id="preview"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        let chapters = [];
        let currentIdx = 0;

        async function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            let text = '';
            const ext = file.name.split('.').pop().toLowerCase();

            if (ext === 'txt') {
                text = await file.text();
            } else if (ext === 'docx') {
                const buf = await file.arrayBuffer();
                const result = await mammoth.extractRawText({arrayBuffer: buf});
                text = result.value;
            } else if (ext === 'pdf') {
                const buf = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: buf}).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(x => x.str).join(' ') + '\n\n';
                }
            }

            processText(text);
        }

        function processText(text) {
            // FIX ENCODING
            text = text.replace(/â€™/g, "'")
                      .replace(/â€œ/g, '"')
                      .replace(/â€/g, '"')
                      .replace(/â€"/g, '—')
                      .replace(/â€"/g, '–')
                      .replace(/Â/g, '')
                      .replace(/â€~/g, "'")
                      .replace(/Ã©/g, 'é')
                      .replace(/Ã¡/g, 'á');

            // Remove markdown
            text = text.replace(/#{1,6}\s/g, '')
                      .replace(/\*\*\*/g, '')
                      .replace(/\*\*/g, '')
                      .replace(/\*/g, '')
                      .replace(/___/g, '')
                      .replace(/__/g, '')
                      .replace(/_/g, '');

            // Split into chapters
            const paras = text.split('\n\n').filter(p => p.trim());
            chapters = [];
            let chapter = {title: 'Chapter 1', content: ''};
            let wordCount = 0;

            for (const p of paras) {
                const words = p.split(/\s+/).length;
                
                if (wordCount > 0 && wordCount + words > 1000) {
                    chapters.push({...chapter});
                    chapter = {title: `Chapter ${chapters.length + 1}`, content: p};
                    wordCount = words;
                } else {
                    chapter.content += (chapter.content ? '\n\n' : '') + p;
                    wordCount += words;
                }
            }
            if (chapter.content) chapters.push(chapter);

            document.getElementById('upload').style.display = 'none';
            document.getElementById('editor').classList.add('active');
            renderNav();
            loadChapter(0);
        }

        function renderNav() {
            document.getElementById('nav').innerHTML = chapters.map((ch, i) =>
                `<button class="page-btn ${i === currentIdx ? 'active' : ''}" onclick="loadChapter(${i})">${ch.title}</button>`
            ).join('');
        }

        function loadChapter(idx) {
            currentIdx = idx;
            document.getElementById('title').value = chapters[idx].title;
            document.getElementById('content').value = chapters[idx].content;
            renderNav();
            updatePreview();
        }

        function updatePreview() {
            const ch = chapters[currentIdx];
            const paras = ch.content.split('\n\n').map(p => `<p>${p}</p>`).join('');
            document.getElementById('preview').innerHTML = `<h2>${ch.title}</h2>${paras}`;
        }

        document.getElementById('title').oninput = () => {
            chapters[currentIdx].title = document.getElementById('title').value;
            renderNav();
            updatePreview();
        };

        document.getElementById('content').oninput = () => {
            chapters[currentIdx].content = document.getElementById('content').value;
            updatePreview();
        };

        function exportHTML() {
            let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>My Ebook</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lora:wght@400&display=swap" rel="stylesheet">
<style>
body{font-family:'Lora',serif;background:#faf8f3;color:#2d2d2d;line-height:1.9;max-width:800px;margin:0 auto;padding:60px 40px}
.chapter{min-height:100vh;padding:80px 0;page-break-after:always}
h2{font-family:'Playfair Display',serif;font-size:3rem;margin-bottom:50px}
p{margin-bottom:25px}
@media print{.chapter{page-break-after:always}}
</style></head><body>`;

            chapters.forEach(ch => {
                const paras = ch.content.split('\n\n').map(p => `<p>${p}</p>`).join('\n');
                html += `<div class="chapter"><h2>${ch.title}</h2>${paras}</div>`;
            });

            html += '</body></html>';

            const blob = new Blob([html], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my-ebook.html';
            a.click();
            
            alert('Ebook exported! Open the HTML file in your browser.');
        }
    </script>
</body>
</html>
